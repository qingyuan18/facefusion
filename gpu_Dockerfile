FROM nvcr.io/nvidia/pytorch:23.06-py3
#FROM nvcr.io/nvidia/pytorch:22.08-py3
#FROM pytorch/pytorch:2.1.0-cuda11.8-cudnn8-devel

ARG FACEFUSION_VERSION=2.6.1
ENV TZ=Etc/UTC
ENV GRADIO_SERVER_NAME=0.0.0.0
ENV PYTHONUNBUFFERED=TRUE
ENV PYTHONDONTWRITEBYTECODE=TRUE
ENV DEBIAN_FRONTEND=noninteractive
ENV PATH=/opt/program:/usr/local/cuda:${PATH}
ENV LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu/:$LD_LIBRARY_PATH



WORKDIR /opt/program

COPY ./ /opt/program



RUN apt-get update
RUN apt-get install git -y
RUN apt-get install curl -y


RUN apt-get install pip -y
RUN apt-get install -y ffmpeg
RUN pip install asgiref


RUN apt-get install nginx -y
RUN pip install --no-cache-dir boto3 flask gunicorn
# for debug only
RUN pip install sagemaker_ssh_helper

##facefusion core dependent
#RUN python install.py --skip-conda --onnxruntime default
RUN python install.py --skip-conda --onnxruntime cuda-12.2

##fix opencv installation issue
RUN pip install opencv-fixer==0.2.5
RUN python -c "from opencv_fixer import AutoFix; AutoFix()"
WORKDIR /opt/program
RUN chmod 755 serve
RUN mkdir -p /tmp/facefusion/test/
RUN chmod -R 777 /tmp/facefusion/test
RUN mkdir -p /opt/program/output/
RUN chmod -R 777 /opt/program/output/

